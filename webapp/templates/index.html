<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planeación de Producción y Simulación</title>
  <link rel="icon" href="/static/favicon.ico">
  <style>
    :root { --bg:#f7f7f7; --card:#fff; --text:#333; --muted:#666; --border:#ddd; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif; }
    .container { max-width:1200px; margin:0 auto; padding:24px; }
    h1 { margin:0 0 8px; font-size:28px; }
    p.lead { margin:0 0 24px; color:var(--muted); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .card h2 { margin:0 0 12px; font-size:18px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; border:1px solid var(--border); border-radius:8px; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(220px,1fr)); gap: 12px; }
    .grid .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; text-transform:uppercase; letter-spacing:.02em; color:#555; }
    .row-actions { display:flex; justify-content:flex-end; gap:12px; }
    button { padding:10px 16px; border:none; border-radius:10px; background:#0f62fe; color:white; font-weight:600; cursor:pointer; }
    button:hover { background:#095ad8; }
    .results-section { margin-top: 24px; }
    .section-title { margin: 28px 0 12px; font-size: 18px; }
    .table-wrap { overflow-x: auto; margin-bottom: 24px; }
    .chart-card { background: var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:28px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .chart-card > div { width:100%; height:360px; }
    .sim-section { margin-bottom: 12px; }
    .sim-table { margin-bottom: 28px; }
    .sim-table:last-child { margin-bottom: 0; }
    .figure-container img { max-width: 100%; height: auto; margin: 8px 0 16px; border-radius:10px; border:1px solid var(--border); }
    .alert { padding:10px 12px; border-radius:8px; border:1px solid #f5c2c7; background:#fff2f3; color:#842029; }
    .ok { padding:10px 12px; border-radius:8px; border:1px solid #cfe8cf; background:#f4fff4; color:#164b16; }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Planeación de Producción y Simulación</h1>
    <p class="lead">Edita los parámetros. Si dejas un campo vacío, se usará el valor por defecto.</p>

    <!-- DEMANDA -->
    <div class="card">
      <h2>Demanda mensual por producto (litros)</h2>
      <table id="data-table">
        <thead>
          <tr>
            <th>Mes</th>
            <th title="Energizante">Energizante</th>
            <th title="Isotónica">Isotónica</th>
            <th title="Agua saborizada">Agua saborizada</th>
            <th title="Té">Té</th>
            <th title="Jugo">Jugo</th>
          </tr>
        </thead>
        <tbody>
          {% for month in month_order %}
            {% set values = default_data[month] %}
            <tr data-month="{{ month }}">
              <td style="text-align:left;font-weight:600">{{ month }}</td>
              {% for idx in range(5) %}
                <td>
                  <input
                    type="number" min="0" step="1"
                    data-month="{{ month }}" data-prod="{{ idx }}"
                    value="{{ values[idx] }}"
                    data-default="{{ values[idx] }}"
                    title="Demanda de {{ month }} para producto {{ idx + 1 }}"
                  />
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted">Sugerencia: pega números rápidamente usando TAB/Shift+TAB.</div>
    </div>

    <!-- TIEMPOS -->
    <div class="card">
      <h2>Tiempos de procesos (minutos)</h2>
      <table id="times-table">
        <thead>
          <tr><th style="width:50%">Parámetro</th><th>Valor</th></tr>
        </thead>
        <tbody>
          {% for key, val in default_times.items() %}
            <tr>
              <td style="text-align:left">{{ key }}</td>
              <td>
                <input
                  type="number" step="0.1" min="0"
                  id="time-{{ key }}"
                  value="{{ val }}"
                  data-default="{{ val }}"
                  title="Tiempo para {{ key }}"
                />
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PARÁMETROS -->
    <div class="card">
      <h2>Parámetros adicionales</h2>
      <div class="grid">
        <div class="field">
          <label title="Proporción de inventario inicial respecto a la venta media mensual">p_inv_inicial</label>
          <input id="p_inv_inicial" type="number" step="0.01" min="0" value="0.25" data-default="0.25" />
        </div>
        <div class="field">
          <label title="Proporción de inventario final requerido en diciembre">p_inv_final</label>
          <input id="p_inv_final" type="number" step="0.01" min="0" value="0.10" data-default="0.10" />
        </div>
        <div class="field">
          <label title="Unidad (litros por lote / conversión)">unidad</label>
          <input id="unidad" type="number" step="0.1" min="1" value="3" data-default="3" />
        </div>
        <div class="field">
          <label title="Costo de producción por litro">ct</label>
          <input id="ct" type="number" step="1" min="0" value="578" data-default="578" />
        </div>
        <div class="field">
          <label title="Costo de inventario por litro-mes">ht</label>
          <input id="ht" type="number" step="1" min="0" value="145" data-default="145" />
        </div>
        <div class="field">
          <label title="Costo de penalización por faltante">pit</label>
          <input id="pit" type="number" step="1" min="0" value="10000000" data-default="10000000" />
        </div>
        <div class="field">
          <label title="Costo por hora regular">crt</label>
          <input id="crt" type="number" step="0.1" min="0" value="5931.25" data-default="5931.25" />
        </div>
        <div class="field">
          <label title="Costo por hora extra">cot</label>
          <input id="cot" type="number" step="0.1" min="0" value="5931.25" data-default="5931.25" />
        </div>
        <div class="field">
          <label title="Costo por contratar trabajadores adicionales">cwt</label>
          <input id="cwt" type="number" step="0.1" min="0" value="5931.25" data-default="5931.25" />
        </div>
        <div class="field">
          <label title="Costo por reducir trabajadores">cwt_prima</label>
          <input id="cwt_prima" type="number" step="0.1" min="0" value="5931.25" data-default="5931.25" />
        </div>
        <div class="field">
          <label title="Costo por unidad producida en el modelo desagregado">costo_prod</label>
          <input id="costo_prod" type="number" step="0.1" min="0" value="1.0" data-default="1.0" />
        </div>
        <div class="field">
          <label title="Costo de inventario en el modelo desagregado">costo_inv</label>
          <input id="costo_inv" type="number" step="0.1" min="0" value="0.25" data-default="0.25" />
        </div>
        <div class="field">
          <label title="Número de réplicas en la simulación">reps</label>
          <input id="reps" type="number" step="1" min="1" value="10" data-default="10" />
        </div>
        <div class="field">
          <label title="Usar restricción de no producir meses consecutivos">use_no_consecutive</label>
          <input id="use_no_consecutive" type="checkbox"/>
        </div>
        <div class="field">
          <label title="Usar suavizado en la producción mensual">use_smooth</label>
          <input id="use_smooth" type="checkbox"/>
        </div>
        <div class="field">
          <label title="Graficar series de producción/demanda">graficar</label>
          <input id="graficar" type="checkbox" checked/>
        </div>
        <div class="field">
          <label title="Retornar tablas de resultados">return_tables</label>
          <input id="return_tables" type="checkbox" checked/>
        </div>
        <div class="field">
          <label title="Generar gráficos de la simulación">make_plots</label>
          <input id="make_plots" type="checkbox" checked/>
        </div>
        <div class="field">
          <label title="Mostrar información detallada en consola">verbose</label>
          <input id="verbose" type="checkbox" checked/>
        </div>
      </div>
      <div class="row-actions"><button id="run-btn" type="button">Planeación</button></div>
      <div class="muted">Tip: los *tooltips* están en los títulos de cada etiqueta.</div>
    </div>

    <!-- RESULTADOS -->
    <div id="results" class="results-section"></div>
  </div>

  <!-- Load SheetJS (for Excel parsing) and Plotly (for interactive charts) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>

  <script>
    // Add file input UI
    const fileUploaderHtml = `
      <div class="card">
        <h2>Subir archivo Excel con demanda mensual</h2>
        <input id="excel-file" type="file" accept=".xlsx,.xls" />
        <div class="muted">Formato esperado: 12 filas (meses) y 5 columnas (productos) o una hoja con encabezados que incluyan los meses.</div>
      </div>
    `;
    document.querySelector('.container').insertAdjacentHTML('afterbegin', fileUploaderHtml);

    let lastResult = null;

    function fallbackNumber(input) {
      const raw = (input.value || '').trim();
      if (raw === '') return parseFloat(input.dataset.default);
      const n = Number(raw);
      return Number.isFinite(n) ? n : parseFloat(input.dataset.default);
    }

    // Populate table from parsed 2D array of numbers
    function populateDemandTableFromArray(arr) {
      // arr expected as array of 12 rows with 5 numbers each
      const tbody = document.querySelector('#data-table tbody');
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((row, i) => {
        if (!arr[i]) return;
        const inputs = row.querySelectorAll('input');
        inputs.forEach((inp, j) => {
          if (typeof arr[i][j] !== 'undefined' && arr[i][j] !== null && !Number.isNaN(Number(arr[i][j]))) {
            inp.value = Number(arr[i][j]);
          }
        });
      });
    }

    // Handle Excel upload
    document.addEventListener('change', (ev) => {
      if (ev.target && ev.target.id === 'excel-file') {
        const f = ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          // try first sheet
          const wsname = workbook.SheetNames[0];
          const ws = workbook.Sheets[wsname];
          const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true});
          // try to extract first 12 rows with at least 5 numbers
          const parsed = [];
          for (let r=0; r<json.length && parsed.length<12; r++) {
            const row = json[r];
            // filter out rows that are empty
            if (!row || row.length === 0) continue;
            // try to find numbers in the row
            const nums = row.slice(0,5).map(x => {
              const n = Number(x);
              return Number.isFinite(n) ? n : null;
            });
            // only accept rows with at least one number
            if (nums.some(v => v !== null)) parsed.push(nums.map(v => v===null?0:v));
          }
          if (parsed.length === 0) {
            alert('No se pudieron leer filas numéricas del archivo. Asegúrese de subir una hoja con valores numéricos.');
            return;
          }
          // if less than 12 rows, warn but still populate top rows
          populateDemandTableFromArray(parsed);
        };
        reader.readAsArrayBuffer(f);
      }
    });

    function gatherData() {
      const data = {};
      document.querySelectorAll('#data-table tbody tr').forEach(row => {
        const month = row.getAttribute('data-month');
        const values = [];
        row.querySelectorAll('input').forEach(input => {
          // usa value si existe, si no, usa data-default
          const raw = (input.value || '').trim();
          const def = parseFloat(input.dataset.default);
          values.push(raw === '' ? def : Number(raw));
        });
        data[month] = values;
      });
      return data;
    }

    function gatherTimes() {
      const times = {};
      document.querySelectorAll('#times-table input').forEach(input => {
        const key = input.id.replace('time-','');
        const val = (input.value || '').trim();
        times[key] = val === '' ? parseFloat(input.dataset.default) : Number(val);
      });
      return times;
    }

    function appendSheet(workbook, records, sheetName, order) {
      if (!records || !records.length) return;
      const headerSet = {};
      records.forEach(row => {
        Object.keys(row || {}).forEach(key => {
          if (!(key in headerSet)) headerSet[key] = true;
        });
      });
      const headers = (order && order.length) ? order : Object.keys(headerSet);
      if (!headers.length) return;
      const normalized = records.map(row => {
        const out = {};
        headers.forEach(h => {
          out[h] = row ? row[h] : null;
        });
        return out;
      });
      const ws = XLSX.utils.json_to_sheet(normalized, { header: headers });
      XLSX.utils.book_append_sheet(workbook, ws, sheetName);
    }

    function attachDownloadHandler() {
      const btn = document.getElementById('download-xlsx');
      if (!btn) return;
      btn.onclick = () => {
        if (!lastResult) {
          alert('Primero ejecuta la planeación para generar datos.');
          return;
        }
        try {
          const wb = XLSX.utils.book_new();
          appendSheet(wb, lastResult.json_agg_table, 'Agregado', ['Mes','P(t)','I(t)','S(t)','L(RT)','NI(t)','D(t)']);
          appendSheet(wb, lastResult.json_disagg_table, 'Desagregado');
          appendSheet(wb, lastResult.json_tabla_produccion, 'Produccion');
          appendSheet(wb, lastResult.json_tabla_inventario, 'Inventario');
          appendSheet(wb, lastResult.json_sim_totales, 'Sim_Totales', ['Metrica','Media','IC95_HW']);
          appendSheet(wb, lastResult.json_sim_productos, 'Sim_Productos');
          appendSheet(wb, lastResult.json_sim_estaciones, 'Sim_Estaciones');
          if (!wb.SheetNames.length) {
            alert('No hay datos para exportar.');
            return;
          }
          XLSX.writeFile(wb, 'planeacion_detallada.xlsx');
        } catch (err) {
          console.error('Error al generar el Excel:', err);
          alert('No se pudo generar el archivo Excel.');
        }
      };
    }

    async function runSimulation() {
      const payload = {
        data: gatherData(),
        p_inv_inicial: fallbackNumber(document.getElementById('p_inv_inicial')),
        p_inv_final:   fallbackNumber(document.getElementById('p_inv_final')),
        tiempos_procesos: gatherTimes(),
        unidad: fallbackNumber(document.getElementById('unidad')),
        use_no_consecutive: document.getElementById('use_no_consecutive').checked,
        use_smooth: document.getElementById('use_smooth').checked,
        ct: fallbackNumber(document.getElementById('ct')),
        ht: fallbackNumber(document.getElementById('ht')),
        pit: fallbackNumber(document.getElementById('pit')),
        crt: fallbackNumber(document.getElementById('crt')),
        cot: fallbackNumber(document.getElementById('cot')),
        cwt: fallbackNumber(document.getElementById('cwt')),
        cwt_prima: fallbackNumber(document.getElementById('cwt_prima')),
        graficar: document.getElementById('graficar').checked,
        costo_prod: fallbackNumber(document.getElementById('costo_prod')),
        costo_inv:  fallbackNumber(document.getElementById('costo_inv')),
        return_tables: document.getElementById('return_tables').checked,
        make_plots: document.getElementById('make_plots').checked,
        reps: fallbackNumber(document.getElementById('reps')),
        verbose: document.getElementById('verbose').checked
      };

      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '<div class="muted">Ejecutando… esto puede tardar unos segundos ⏳</div>';
      lastResult = null;

      try {
        const res = await fetch('/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();

        if (!res.ok || result.error) {
          resultsEl.innerHTML = `<div class="alert"><strong>Error:</strong> ${result.error || 'Error desconocido'}</div>`;
          return;
        }

        // Build basic info area
        const noData = '<div class="muted">No disponible.</div>';
        let html = '';
        html += `<div class="ok"><strong>Estado del modelo agregado:</strong> ${result.status} &nbsp; | &nbsp; <strong>Valor objetivo:</strong> ${result.z}</div>`;
        html += `<div class="row-actions" style="margin-top:12px;"><button type="button" id="download-xlsx">Descargar Excel detallado</button></div>`;

        html += `<h3 class="section-title">Tabla de Demanda Planificada (mensual)</h3>`;
        html += `<div id="agg-table-area" class="table-wrap">`;
        if (result.json_agg_table) {
          const rows = result.json_agg_table;
          html += '<table class="table table-sm table-bordered"><thead><tr><th>Mes</th><th>P(t)</th><th>I(t)</th><th>S(t)</th><th>L(RT)</th><th>NI(t)</th><th>D(t)</th></tr></thead><tbody>';
          for (const r of rows) {
            html += `<tr><td>${r.Mes}</td><td>${r['P(t)']}</td><td>${r['I(t)']}</td><td>${r['S(t)']}</td><td>${r['L(RT)']}</td><td>${r['NI(t)']}</td><td>${r['D(t)']}</td></tr>`;
          }
          html += '</tbody></table>';
        } else {
          html += result.tabla_desag || noData;
        }
        html += `</div>`;

        html += `<h3 class="section-title">Gráfico: Demanda planificada vs Producción (interactivo)</h3>`;
        html += `<div class="chart-card"><div id="plot-demand"></div></div>`;
        html += `<h3 class="section-title">Gráfico: Desagregación por producto (interactivo)</h3>`;
        html += `<div class="chart-card"><div id="plot-desag"></div></div>`;

        html += `<h3 class="section-title">Tabla de producción mensual por producto</h3>`;
        html += `<div class="table-wrap">${result.tabla_prod || noData}</div>`;
        html += `<h3 class="section-title">Tabla de inventario mensual por producto</h3>`;
        html += `<div class="table-wrap">${result.tabla_inv || noData}</div>`;

        html += `<h3 class="section-title">Simulación - Métricas Totales</h3>`;
        html += `<div class="chart-card"><div id="plot-sim-totales"></div></div>`;
        html += `<h3 class="section-title">Simulación - Métricas por producto</h3>`;
        html += `<div class="chart-card"><div id="plot-sim-productos"></div></div>`;
        html += `<h3 class="section-title">Simulación - Métricas por estación</h3>`;
        html += `<div class="chart-card"><div id="plot-sim-estaciones-util"></div></div>`;
        html += `<div class="chart-card"><div id="plot-sim-estaciones-wait"></div></div>`;

        html += `<h3 class="section-title">Tablas de la simulación</h3>`;
        html += `<div class="sim-section">`;
        html += `<div class="sim-table">${result.df_totales || noData}</div>`;
        html += `<div class="sim-table">${result.df_productos || noData}</div>`;
        html += `<div class="sim-table">${result.df_estaciones || noData}</div>`;
        html += `</div>`;

        resultsEl.innerHTML = html;
        lastResult = result;
        attachDownloadHandler();

        // Render interactive plots if JSON data present
        try {
          const plotConfig = { responsive: true, displaylogo: false };
          if (result.json_agg_table && result.json_agg_table.length) {
            const agg = result.json_agg_table;
            const months = agg.map(r => r.Mes);
            const prodSeries = agg.map(r => Number(r['P(t)'] || 0));
            const demSeries = agg.map(r => Number(r['D(t)'] || 0));
            const traces = [
              { x: months, y: prodSeries, name: 'P(t) producción', mode: 'lines+markers' },
              { x: months, y: demSeries, name: 'D(t) demanda', mode: 'lines+markers' }
            ];
            const layout = {
              title: 'Comportamiento: Producción vs Demanda',
              xaxis: { title: 'Mes' },
              yaxis: { title: 'Unidades' },
              legend: { orientation: 'h', y: -0.2 },
              height: 360
            };
            Plotly.newPlot('plot-demand', traces, layout, plotConfig);
          }
          if (result.json_tabla_produccion) {
            const prodRows = result.json_tabla_produccion;
            if (prodRows && prodRows.length > 0) {
              const months = prodRows.map(r => r.Mes || r.index || '');
              const cols = Object.keys(prodRows[0]).filter(k => k !== 'index' && k !== 'Mes');
              const traces = cols.map(col => ({
                x: months,
                y: prodRows.map(r => Number(r[col] || 0)),
                name: col,
                mode: 'lines+markers'
              }));
              const layout2 = {
                title: 'Producción mensual por producto',
                xaxis: { title: 'Mes' },
                yaxis: { title: 'Litros' },
                legend: { orientation: 'h' },
                height: 360
              };
              Plotly.newPlot('plot-desag', traces, layout2, plotConfig);
            }
          }
          if (result.json_sim_totales && result.json_sim_totales.length) {
            const data = result.json_sim_totales;
            const metricas = data.map(r => r.Metrica);
            const medias = data.map(r => Number(r.Media || 0));
            const errores = data.map(r => Number(r.IC95_HW || 0));
            const traceTot = {
              type: 'bar',
              x: metricas,
              y: medias,
              marker: { color: '#0f62fe' },
              error_y: { type: 'data', array: errores, visible: true, thickness: 1.5 }
            };
            const layoutTot = {
              title: 'Métricas agregadas de la simulación',
              xaxis: { title: 'Métrica' },
              yaxis: { title: 'Valor medio' },
              height: 360
            };
            Plotly.newPlot('plot-sim-totales', [traceTot], layoutTot, plotConfig);
          }
          if (result.json_sim_productos && result.json_sim_productos.length) {
            const dataProd = result.json_sim_productos;
            const productos = dataProd.map(r => r.Producto);
            const metricConfigs = [
              { key: 'Throughput_media', err: 'Throughput_HW', label: 'Throughput (lotes/día)', axis: 'Throughput [lotes/día]' },
              { key: 'CycleTime_media_min', err: 'CycleTime_HW', label: 'Cycle time (min)', axis: 'Cycle time [min]' },
              { key: 'WIP_media', err: 'WIP_HW', label: 'WIP (lotes)', axis: 'WIP [lotes]' },
              { key: 'TaktTime_media_min', err: 'TaktTime_HW', label: 'Takt time (min/lote)', axis: 'Takt time [min/lote]' },
              { key: 'Entradas_365d_media', err: 'Entradas_365d_HW', label: 'Entradas en 365d (lotes)', axis: 'Entradas [lotes]' }
            ];
            const tracesProd = metricConfigs.map((cfg, idx) => ({
              type: 'bar',
              x: productos,
              y: dataProd.map(r => Number(r[cfg.key] || 0)),
              error_y: { type: 'data', array: dataProd.map(r => Number(r[cfg.err] || 0)), visible: true },
              name: cfg.label,
              visible: idx === 0
            }));
            const buttons = metricConfigs.map((cfg, idx) => ({
              label: cfg.label,
              method: 'update',
              args: [
                { visible: tracesProd.map((_, i) => i === idx) },
                { title: `Simulación - ${cfg.label}`, yaxis: { title: cfg.axis } }
              ]
            }));
            const layoutProd = {
              title: `Simulación - ${metricConfigs[0].label}`,
              xaxis: { title: 'Producto' },
              yaxis: { title: metricConfigs[0].axis },
              updatemenus: [{
                x: 0.5,
                y: 1.25,
                xanchor: 'center',
                yanchor: 'top',
                direction: 'down',
                showactive: true,
                buttons
              }],
              showlegend: false,
              height: 360
            };
            Plotly.newPlot('plot-sim-productos', tracesProd, layoutProd, plotConfig);
          }
          if (result.json_sim_estaciones && result.json_sim_estaciones.length) {
            const dataEst = result.json_sim_estaciones;
            const estaciones = dataEst.map(r => r.Estacion);
            if (estaciones.length) {
              const utilValues = dataEst.map(r => Number(r.Utilizacion_media || 0));
              const utilErrors = dataEst.map(r => Number(r.Utilizacion_HW || 0));
              const maxUtil = utilValues.length ? Math.max(...utilValues) : 1;
              const utilTrace = {
                type: 'bar',
                x: estaciones,
                y: utilValues,
                error_y: { type: 'data', array: utilErrors, visible: true },
                marker: { color: '#3d70ff' }
              };
              const layoutUtil = {
                title: 'Simulación - Utilización por estación',
                xaxis: { title: 'Estación' },
                yaxis: { title: 'Utilización', tickformat: '.0%', range: [0, Math.min(1, maxUtil + 0.1)] },
                showlegend: false,
                height: 360
              };
              Plotly.newPlot('plot-sim-estaciones-util', [utilTrace], layoutUtil, plotConfig);
            }
            const waitValues = dataEst.map(r => Number(r.Espera_media_min || 0));
            const waitErrors = dataEst.map(r => Number(r.Espera_HW || 0));
            const waitTrace = {
              type: 'bar',
              x: estaciones,
              y: waitValues,
              error_y: { type: 'data', array: waitErrors, visible: true },
              marker: { color: '#ff832b' }
            };
            const layoutWait = {
              title: 'Simulación - Espera media por estación',
              xaxis: { title: 'Estación' },
              yaxis: { title: 'Espera [min]' },
              showlegend: false,
              height: 360
            };
            Plotly.newPlot('plot-sim-estaciones-wait', [waitTrace], layoutWait, plotConfig);
          }
        } catch (errplot) {
          console.warn('Error al renderizar plots interactivos:', errplot);
        }
      } catch (err) {
        resultsEl.innerHTML = `<div class="alert"><strong>Ocurrió un error:</strong> ${err}</div>`;
      }
    }

    document.getElementById('run-btn').addEventListener('click', runSimulation);
  </script>
</body>
</html>
